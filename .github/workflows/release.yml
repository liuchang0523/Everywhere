name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Enable long paths in git
      run: git config --global core.longpaths true

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: true
        lfs: true
    
    - name: Get version from tag
      id: get_version
      shell: pwsh
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
        echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Extract Release Notes from CHANGELOG.md
      id: get_release_notes
      shell: pwsh
      run: |
        $changelog = Get-Content -Path CHANGELOG.md -Raw
        $version = "${{ env.VERSION }}"
        # Use regex to match the content from the current version's header
        # to the next version's header or the end of the file.
        # (?s) makes . match newlines, (?m) makes ^ match the start of a line.
        $pattern = "(?sm)(^##\s+\[v$([regex]::Escape($version))\].*?)(?=^##\s+\[v|\z)"
        $match = [regex]::Match($changelog, $pattern)
        
        if (-not $match.Success) {
          Write-Error "Could not find release notes for v${version} in CHANGELOG.md"
          exit 1
        }
        
        # Remove the first line (the version header)
        $releaseBody = $match.Value.Split([System.Environment]::NewLine, 2)[1].Trim()
        
        # Set the multi-line output for the step
        $delimiter = "EOF_$(Get-Random)"
        echo "body<<$delimiter" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        echo $releaseBody | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        echo "$delimiter" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

    - name: Setup .NET
      uses: actions/setup-dotnet@v4.3.1
      with:
        global-json-file: ${{ github.workspace }}/global.json

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Install SimplySignDesktop
      shell: pwsh
      run: |
        $msiPath = "tools/sign_windows/SimplySignDesktop-9.3.3.71-64-bit-en.msi"
        if (-not (Test-Path $msiPath)) {
            Write-Error "MSI file not found at: $msiPath"
            exit 1
        }

        $absMsiPath = Convert-Path $msiPath
        $logPath = "$PWD\install.log"

        Write-Host "Installing SimplySignDesktop from $absMsiPath..."
        # Use /qn for completely silent installation (no UI) and ALLUSERS=1 to force machine-wide install
        $process = Start-Process msiexec -ArgumentList "/i `"$absMsiPath`" /qn /norestart ALLUSERS=1 /l*v `"$logPath`"" -Wait -PassThru
        
        if ($process.ExitCode -ne 0) {
            Write-Host "SimplySignDesktop installation failed with exit code $($process.ExitCode)"
            if (Test-Path $logPath) {
                Write-Host "----------------------------------------------------------------"
                Write-Host "Install Log Content:"
                Write-Host "----------------------------------------------------------------"
                Get-Content $logPath
                Write-Host "----------------------------------------------------------------"
            } else {
                Write-Host "Log file not found at $logPath"
            }
            exit $process.ExitCode
        }
        Write-Host "SimplySignDesktop installed successfully."

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Restore
      shell: pwsh
      run: |
        dotnet restore Everywhere.Windows.slnf -r win-x64

    - name: Publish Everywhere.Windows
      shell: pwsh
      run: |
        dotnet publish src/Everywhere.Windows/Everywhere.Windows.csproj -c Release --self-contained true -p:Version=$env:VERSION -o ./publish --no-restore

    - name: Login and Sign
      shell: pwsh
      env:
          SIGN_USERNAME: ${{ secrets.CERTUM_USERNAME }}
          SIGN_OTP_TOKEN: ${{ secrets.CERTUM_OTP_TOKEN }}
      run: |
        python -m pip install --upgrade pip
        pip install pyotp
        # python -u tools/sign_windows/sign.py ./publish

    # - name: Install Inno Setup
      # shell: pwsh
      # run: |
        # choco install innosetup

    # - name: Compile .ISS to .EXE Installer
      # shell: pwsh
      # run: |
        # & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "tools/installer.iss" /O+
        # if ($LASTEXITCODE -ne 0) {
          # Write-Error "Inno Setup compilation failed with exit code $LASTEXITCODE"
          # exit $LASTEXITCODE
        # }

    - name: Create release zip
      shell: pwsh
      run: |
        Compress-Archive -Path ./publish/* -DestinationPath ./Everywhere-Windows-x64-v$env:VERSION.zip

    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        name: Everywhere v${{env.VERSION}}
        body: ${{ steps.get_release_notes.outputs.body }}
        draft: false
        prerelease: false
        files: |
          ./Everywhere-Windows-x64-v${{env.VERSION}}.zip
          # ./Everywhere-Windows-x64-Setup-v${{env.VERSION}}.exe

  build-mac:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - runtime: osx-x64
            asset_name: macOS-x64
          - runtime: osx-arm64
            asset_name: macOS-arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: true
        lfs: true

    - name: Get version from tag
      id: get_version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Import Code Signing Certificate
      env:
        P12_BASE64: ${{ secrets.MACOS_CERTIFICATE_BASE64 }}
        P12_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
      run: |
        # Create a temporary keychain
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        security create-keychain -p "" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "" $KEYCHAIN_PATH

        # Decode the P12 file
        CERT_PATH=$RUNNER_TEMP/certificate.p12
        echo "$P12_BASE64" | base64 --decode -o $CERT_PATH

        # Import the certificate
        security import $CERT_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH

    - name: Replace Version inside Info.plist
      run: |
        /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ env.VERSION }}" src/Everywhere.Mac/Info.plist
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ env.VERSION }}" src/Everywhere.Mac/Info.plist

    - name: Restore
      run: dotnet restore src/Everywhere.Mac/Everywhere.Mac.csproj -r ${{ matrix.runtime }}

    - name: Publish
      env:
        CODE_SIGN_KEY: ${{ secrets.CODE_SIGN_KEY }}
        PACKAGE_SIGNING_KEY: ${{ secrets.PACKAGE_SIGNING_KEY }}
      run: |
        dotnet publish src/Everywhere.Mac/Everywhere.Mac.csproj -c Release -r ${{ matrix.runtime }} /p:CodesignKey="$CODE_SIGN_KEY" /p:PackageSigningKey="$PACKAGE_SIGNING_KEY" -p:Version=${{ env.VERSION }} -o ./publish --no-restore

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      with:
        files: Everywhere-${{ matrix.asset_name }}-v${{ env.VERSION }}.pkg
